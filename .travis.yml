# # # Use new container infrastructure to enable caching
sudo: 
  false

# # # Choose a lightweight base image (C); we provide our own build tools.

language: 
  c 


# # # The different configurations we want to test. You could also do things like
# # # change flags or use --stack-yaml to point to a different file.

env:
  - STACK_ARGS=""
  - STACK_ARGS="--resolver lts-2"
  - STACK_ARGS="--resolver lts-3"
  - STACK_ARGS="--resolver lts"
  - STACK_ARGS="--resolver nightly"


# # # Install GFortran via apt-get.
# # # See http://docs.travis-ci.com/user/apt/ for more information

addons:
  apt:
    packages:
    - gfortran            # needed to build PETSc
    - libgmp-dev          # needed by GHC




before_install:

  # # # environment variables : 

  - export PETSC_DIR="$PWD"/petsc
  - export PETSC_ARCH=arch-linux2-c-debug 

  - export SLEPC_DIR="$PWD"/slepc
  - export SLEPC_ARCH=arch-linux2-c-debug 

  - export PETSC_INCLUDE1="$PETSC_DIR"/include/
  - export PETSC_INCLUDE2="$PETSC_DIR"/"$PETSC_ARCH"/include/
  - export PETSC_LIB="$PETSC_DIR"/"$PETSC_ARCH"/lib/

  - export SLEPC_INCLUDE1="$SLEPC_DIR"/include/
  - export SLEPC_INCLUDE2="$SLEPC_DIR"/"$SLEPC_ARCH"/include/
  - export SLEPC_LIB="$SLEPC_DIR"/"$SLEPC_ARCH"/lib/

  - export PETSC_VERSION=3.6.2
  - export SLEPC_VERSION=3.6.1

  - echo $HOME
  - printenv | grep PETSC
  - printenv | grep SLEPC


  # # # make directories

  - mkdir -p "$HOME"/.local/bin
  - mkdir -p $PETSC_DIR
  - mkdir -p $SLEPC_DIR

  # # # PATH

  - export PATH=$HOME/.local/bin:$PATH



  # # # set execution permissions for dep install scripts

  - chmod +x install-petsc.sh
  - chmod +x install-slepc.sh


  # # # INSTALL DEPENDENCIES

  # Download and install PETSc, MPICH, FBLASLAPACK
  - travis_retry ./install-petsc.sh $PETSC_VERSION $PETSC_DIR $PETSC_ARCH

  # Download and install SLEPc
  - travis_retry ./install-slepc.sh $SLEPC_VERSION $SLEPC_DIR 




  # # # ARE THE DEPS INSTALLED ?

  - pwd

  - cd $PETSC_DIR
  - pwd
  - ls -lsA 
  - cd ..

  - ls -lsA $SLEPC_DIR



  # Download and unpack the `stack` executable :

  - travis_retry curl -L https://www.stackage.org/stack/linux-x86_64 | tar xz --wildcards --strip-components=1 -C $HOME/.local/bin '*/stack'


  # augment bash path with stack path :

  - export PATH=$(stack --stack-yaml stack.yaml path --local-install-root):$PATH



# # This line does all of the work: installs GHC if necessary, build the library,
# # executables, and test suites, and runs the test suites. --no-terminal works
# # around some quirks in Travis's terminal implementation.

script: 

  # bash script-based:
  - ./stack-build.sh $STACK_ARGS $PETSC_DIR $PETSC_ARCH $SLEPC_DIR $SLEPC_ARCH


  # let's see if stack tells the truth, after which `stack path` 
  # and `stack exec petsc-example` shd work :
  - stack setup

  # # where is the petsc-example binary? 
  - stack path

  # #   - export BIN_DIR="$(stack path --dist-dir)/build"

  # # # run an example program
  - stack exec petsc-example

  # # stack $ARGS --no-terminal --install-ghc test --haddock




# cache:
#   directories:
#   - $PETSC_DIR
#   - $SLEPC_DIR
# #   - $HOME/.stack


